<!DOCTYPE html>
<html lang="en" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="ZIGGO is implemented on ZYNQ-7000 SoC and exploits ZYNQ&rsquo;s both hardware and software programmability.">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="http://localhost:1313/docs/device/system-design/">
  <meta property="og:site_name" content="ZIGGO BOOK">
  <meta property="og:title" content="System Design">
  <meta property="og:description" content="ZIGGO is implemented on ZYNQ-7000 SoC and exploits ZYNQ’s both hardware and software programmability.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="docs">
    <meta property="article:published_time" content="2024-05-01T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-05-01T00:00:00+00:00">
    <meta property="article:tag" content="ZIGGO-Device">
    <meta property="article:tag" content="ZIGGO">
    <meta property="article:tag" content="Markdown">
    <meta property="og:image" content="http://localhost:1313/docs/device/system-design/featured.jpg">
<title>System Design | ZIGGO BOOK</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" >
<link rel="canonical" href="http://localhost:1313/docs/device/system-design/">
  <link rel="alternate" hreflang="zh" href="http://localhost:1313/zh/docs/device/system-design/" title="系统设计">
<link rel="stylesheet" href="/book.min.309b7ed028807cdb68d8d61e26d609f48369c098dbf5e4d8c0dcf4cdf49feafc.css" integrity="sha256-MJt&#43;0CiAfNto2NYeJtYJ9INpwJjb9eTYwNz0zfSf6vw=" crossorigin="anonymous">
  <script defer src="/fuse.min.js"></script>
  <script defer src="/en.search.min.880afd6a6348ab60e7c50e6108464ff34c45db0bc79bb5f304f9cbda917a04c1.js" integrity="sha256-iAr9amNIq2DnxQ5hCEZP80xF2wvHm7XzBPnL2pF6BME=" crossorigin="anonymous"></script>

  

<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><img src="/logo.png" alt="Logo" /><span>ZIGGO BOOK</span>
  </a>
</h2>


<div class="book-search hidden">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>
<script>document.querySelector(".book-search").classList.remove("hidden")</script>



  



  
    
  


  


<ul class="book-languages">
  <li>
    <input type="checkbox" id="languages" class="toggle" />
    <label for="languages" class="flex justify-between">
      <a role="button" class="flex align-center">
        <img src="/svg/translate.svg" class="book-icon" alt="Languages" />
        English
      </a>
    </label>

    <ul>
      
      <li>
        <a href="http://localhost:1313/zh/docs/device/system-design/">
          Chinese
        </a>
      </li>
      
    </ul>
  </li>
</ul>











  



  
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-f7037f1d8c98cfd6af893e54a7a7c84a" class="toggle"  />
    <label for="section-f7037f1d8c98cfd6af893e54a7a7c84a" class="flex justify-between">
      <a href="/docs/tsnperf/" class="">ZIGGO TSNPerf</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/tsnperf/principle/" class="">TSNPerf Design Principles</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/tsnperf/configuration/" class="">TSNPerf User Guide</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/tsnperf/manual/" class="">TSNPerf Test Content and Usage Table</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/tsnperf/report/" class="">Report for Brand A Switch</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-d43c4f20a039dd2c08c63c6629ffaedf" class="toggle"  />
    <label for="section-d43c4f20a039dd2c08c63c6629ffaedf" class="flex justify-between">
      <a href="/docs/switch/" class="">ZIGGO Switch</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/switch/basic_knowledge/" class="">List of Basic Knowledge</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/switch/require/" class="">Preparation Checklist</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/switch/system-design/" class="">System Design</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/switch/hardware-build/" class="">Hardware Build</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/switch/software-build/" class="">Software Build</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/switch/contributing/" class="">How to contribute</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-9944d1fadd4ce8adc7644b141d205c6b" class="toggle" checked />
    <label for="section-9944d1fadd4ce8adc7644b141d205c6b" class="flex justify-between">
      <a href="/docs/device/" class="">ZIGGO Device</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/device/basic_knowledge/" class="">List of Basic Knowledge</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/device/require/" class="">Preparation Checklist</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/device/getting-started/" class="">Getting start</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/device/system-design/" class="active">System Design</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/device/hardware-build/" class="">Hardware Build</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/device/software-build/" class="">Software Build</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/device/ziggo_device_manual/" class="">ZIGGO Device Manual</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/device/cnc_manual/" class="">CNC Script Usage Guide</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/device/testbed/" class="">TestBed Setup Process</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/device/contributing/" class="">How to contribute</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>















</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>System Design</strong>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  <div style="margin-top:10px; margin-bottom:40px; display:flex; justify-content:center; gap: 25px;">
    <a href="https://github.com/MobiSense/ziggo_book" style="padding: 10px 10px;
	background-color: rgb(0, 0, 0); /* 设置按钮背景色为橙色 */
	color: white; /* 设置按钮文字颜色为白色 */
	text-decoration: none; /* 去除链接的下划线 */
	border: 3px solid rgb(0, 0, 0);
	border-radius: 5px; /* 设置按钮的边角为圆角 */
	font-size: 14px; /* 设置文字大小 */
	text-align: center; /* 按钮内文字居中显示 */
	display: inline-block; /* 使链接的布局表现为块级元素 */">GitHub</a>
    <a href="https://mobisense.github.io/ziggo_homepage/" style="padding: 10px 10px;
	background-color: rgb(0, 0, 0); /* 设置按钮背景色为橙色 */
	color: white; /* 设置按钮文字颜色为白色 */
	text-decoration: none; /* 去除链接的下划线 */
	border: 3px solid rgb(0, 0, 0);
	border-radius: 5px; /* 设置按钮的边角为圆角 */
	font-size: 14px; /* 设置文字大小 */
	text-align: center; /* 按钮内文字居中显示 */
	display: inline-block; /* 使链接的布局表现为块级元素 */">Home</a>
</div>

<nav id="TableOfContents">
  <ul>
    <li><a href="#table-of-content">Table of Content</a></li>
    <li><a href="#evaluation-method">Evaluation Method</a></li>
    <li><a href="#test-data-frame-data-structure">Test data frame data structure</a></li>
    <li><a href="#module-design">Module Design</a>
      <ul>
        <li><a href="#correspondence-between-software-and-hardware-registers">Correspondence between software and hardware registers</a></li>
        <li><a href="#offline-analysis-and-design">Offline Analysis and Design</a></li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown book-article"><h1 id="system-design">
  System Design
  <a class="anchor" href="#system-design">#</a>
</h1>
<p>ZIGGO is implemented on ZYNQ-7000 SoC and exploits ZYNQ&rsquo;s both hardware and software programmability.</p>
<p><img src="./framework.jpg" alt="framework" /></p>
<h2 id="table-of-content">
  Table of Content
  <a class="anchor" href="#table-of-content">#</a>
</h2>
<ul>
<li><a href="#system-design">System Design</a>
<ul>
<li><a href="#table-of-content">Table of Content</a></li>
<li><a href="#evaluation-method">Evaluation Method</a></li>
<li><a href="#test-data-frame-data-structure">Test data frame data structure</a></li>
<li><a href="#module-design">Module Design</a>
<ul>
<li><a href="#correspondence-between-software-and-hardware-registers">Correspondence between software and hardware registers</a></li>
<li><a href="#offline-analysis-and-design">Offline Analysis and Design</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="evaluation-method">
  Evaluation Method
  <a class="anchor" href="#evaluation-method">#</a>
</h2>
<p>The ZIGGO Evaluation Toolkit is used to send and receive test data frames for the purpose of ensuring <code>accurate delay calculations</code>.</p>
<p>To achieve this accuracy, the toolkit needs to <strong>synchronize its time</strong> with the TSN switch and record a <strong>global hardware timestamp</strong> in the test data frames.</p>
<p>As shown in the diagram below, in a data flow link with 
<link rel="stylesheet" href="/katex/katex.min.css" />
<script defer src="/katex/katex.min.js"></script>
<script defer src="/katex/auto-render.min.js" onload="renderMathInElement(document.body);"></script><span class="optional">
  \( n \)
</span>
 network nodes, Node <span class="optional">
  \( 1 \)
</span>
 serves as the source node to send test data frames, Node <span class="optional">
  \( n \)
</span>
 acts as the destination node to receive test data frames, and all the intermediate nodes (Node <span class="optional">
  \( 2 \)
</span>
 to Node <span class="optional">
  \( n-1 \)
</span>
) are TSN switches.</p>
<p>When a test data frame is sent from the source node, the hardware records the timestamp <span class="optional">
  \( t^&#43; \)
</span>
 of when the frame was sent in the data frame. Finally, when the data frame arrives at the destination node, the destination node records the timestamp <span class="optional">
  \( t^- \)
</span>
 of when the frame entered that node. By calculating <span class="optional">
  \( t^--t^&#43; \)
</span>
, we can determine the end-to-end latency of the data frame.</p>
<p><img src="./device_test_demo.png" alt="device_test_demo" /></p>
<blockquote>
<p>In this doc, <span class="optional">
  \( t^{dir} \)
</span>
 is used to represent the timestamp of data frames entering and leaving the hardware. Here, &ldquo;dir&rdquo; represents the direction of data frames entering or leaving the nodes, with &quot; + &quot; indicating data frames leaving the node and &quot; − &quot; indicating data frames entering the node.</p>
</blockquote>
<h2 id="test-data-frame-data-structure">
  Test data frame data structure
  <a class="anchor" href="#test-data-frame-data-structure">#</a>
</h2>
<p>In order to analyze the end-to-end latency of each data frame on complex network topologies, we have established specific guidelines for the content of data segments in the Ethernet frame structure. The structure of time-sensitive networking test data frames is as shown in the following table.</p>
<table>
<thead>
<tr>
<th>ield</th>
<th>Byte Length</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Destination Address</td>
<td>6</td>
<td>Destination node MAC address</td>
</tr>
<tr>
<td>Source Address</td>
<td>6</td>
<td>Source node MAC address</td>
</tr>
<tr>
<td>VLAN Tag</td>
<td>4</td>
<td>Divided into four fields: VLAN Data Frame Type (0x8100), Priority, Canonical Format Indicator, and VLAN Number</td>
</tr>
<tr>
<td>Data Frame Type</td>
<td>2</td>
<td>Used to identify test data frames, set to 0x66ab</td>
</tr>
<tr>
<td>Reserved Bits</td>
<td>2</td>
<td></td>
</tr>
<tr>
<td><span class="optional">
  \( t^&#43; \)
</span>
 (TX Timestamp)</td>
<td>8</td>
<td>Timestamp when transmitted from the source node</td>
</tr>
<tr>
<td><span class="optional">
  \( t^- \)
</span>
 (RX Timestamp)</td>
<td>8</td>
<td>Timestamp when received by the destination node</td>
</tr>
<tr>
<td>Data Stream ID (SEQ_ID)</td>
<td>2</td>
<td>Unique identifier for each data stream</td>
</tr>
<tr>
<td>Data Frame ID (PKT_ID)</td>
<td>4</td>
<td>Sequence number of data frames within each data stream, starting from 0</td>
</tr>
</tbody>
</table>
<h2 id="module-design">
  Module Design
  <a class="anchor" href="#module-design">#</a>
</h2>
<p>The overall module design for ZIGGO Evaluation Toolkit is depicted in the following diagram. The Time Synchronization module used by the Toolkit shares a design that is nearly identical to the Switch, and the diagram does not provide extensive details on the time synchronization-related modules.</p>
<p>The configuration module in the PS section (<code>software/pkt_gen_main.cpp</code>) communicates with the Data Frame Generation module by using the UIO driver and AXI4-Lite interface to send the transmission rules for the test data frames to relevant registers in the Data Frame Generation module (specifically, <code>hardware/IP_repo/pkt_gen_controller_v1.1/pkt_gen_controller_1.1/hdl/pkt_gen_controller_v1_1.v</code> is responsible for configuration, and <code>hardwire/HDL/axi_packet_generator.v</code> is responsible for generating and transmitting the data frames) using the global synchronized time as a reference for timing.</p>
<p>The Timestamp Marking module (<code>hardwire/HDL/hw_timestamp/tsu/tsu_axis_tx.v</code> and     <code>hardwire/HDL/hw_timestamp/tsu/tsu_axis_rx.v</code>) is located at the send and receive ports of the Ziggo-Evaluation-Toolkit. It is used to record the hardware timestamps of sent and received data frames within the test data frames.</p>
<p>The received data frames are ultimately uploaded to the PS section via a DMA channel (in our design, we currently use a time-synchronized DMA channel for transmitting test data frames) for statistical analysis (handled in the <code>process_critical_frame</code> function in <code>software/pkt_gen_control/pkt_gen.c</code>).</p>
<p><img src="./device_arch.png" alt="device_arch" /></p>
<p>The maximum frame transmission period (superperiod parameter in <code>pkt_gen_main.cpp</code>) refers to the upper limit on the periodicity for sending data streams from the toolkit. Within this maximum frame transmission period, the Data Frame Generation module allocates a maximum of 32 time slots for all data streams. Each time slot is used to send all the data frames for the corresponding data stream at the specified transmission time.</p>
<p>As illustrated in the diagram, the evaluation toolkit sends two types of data streams: Stream 𝐹1 with a transmission period of 2𝑇 and Stream 𝐹2 with a transmission period of 4𝑇. The maximum frame transmission period for the evaluation toolkit is 6𝑇. In this scenario, the Data Frame Generation module sets up 5 time slots within the maximum frame transmission period and sends test data frames in sequential order according to the specified time slots.</p>
<p><img src="./example_pkt_gen_period.png" alt="example_pkt_gen_period" /></p>
<p>Users can configure the Ziggo-Evaluation-Toolkit to generate multiple data streams, and the configuration parameters for each data stream are as follows, with clear explanations provided in the comments of the <code>pkt_gen.h</code> header file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span><span style="color:#75715e">// pkt_gen_app\pkt_gen_control\pkt_gen.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @brief Set the pkt gen slot object
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param slot_id 0~31, indicate a slot in pkt_gen IP core
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *      IMPORTANT: tx_offset for each slot id should be monotonic increasing
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param seq_id sequence ID that uniquely identify a stream
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *              To further utilize this field, it may be {job_id: 8bit, flow_id: 8bit}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param pkt_number number of packets in one sent, should be 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param pkt_id_start start of pkt_id
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param pkt_id_update update of next pkt_id
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param tx_offset transmission time inside a period, in ns
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param src_mac 6Byte array
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param dest_mac 6Byte array
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @return int 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">set_pkt_gen_slot</span> (<span style="color:#66d9ef">int</span> slot_id, <span style="color:#66d9ef">uint16_t</span> seq_id, <span style="color:#66d9ef">uint16_t</span> pkt_number, <span style="color:#66d9ef">uint32_t</span> pkt_id_start, 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">uint32_t</span> pkt_id_update, <span style="color:#66d9ef">int64_t</span> tx_offset, <span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span>src_mac, <span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span>dest_mac);
</span></span></code></pre></div><p>The Timestamp Marking Module will write the timestamp of the current synchronized clock into the outgoing data frame just before it is transmitted by the MAC controller of the toolkit. When the MAC controller in the PL (Programmable Logic) receives the first bit of data in the frame from the physical link, the Timestamp Marking Module records the timestamp of the current synchronized clock. It subsequently writes this timestamp into the data frame during the packet reception process and hands it over to the statistical analysis module in the PS (Processing System) section for further analysis and processing.</p>
<h3 id="correspondence-between-software-and-hardware-registers">
  Correspondence between software and hardware registers
  <a class="anchor" href="#correspondence-between-software-and-hardware-registers">#</a>
</h3>
<p>The correspondence in terms of time synchronization is the same as in the Ziggo TSN Switch.</p>
<p>In this section, we will primarily focus on the correspondence related to data frame transmission configuration. The software registers&rsquo; addresses can be found in <code>software/pkt_gen_control/pkt_gen.c</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span><span style="color:#75715e">// define global register address
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define GLOBAL_PERIOD_NS    0x00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define GLOBAL_OFFSET_NS    0x00000008
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define SEQ_VALID           0x00000010
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define SEQ_ENABLE_VLAN     0x00000014
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define WRITE_LOCK          0x00000018
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// define write lock value
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define NOT_WRITING     0x00000001
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define WRITING         0x00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// define address pointer for sequences
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define SEQ_CONTENT     0x0000001c
</span></span></span></code></pre></div><p>The hardware registers are located in <code>tsn_device\IP_repo\pkt_gen_controller_v1.1\pkt_gen_controller_1.1\hdl\pkt_gen_controller_v1_1_S00_AXI.v</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (slv_reg_wren)
</span></span><span style="display:flex;"><span>      begin
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> ( axi_awaddr[ADDR_LSB<span style="color:#f92672">+</span>OPT_MEM_ADDR_BITS:ADDR_LSB] )
</span></span><span style="display:flex;"><span>          <span style="color:#ae81ff">9</span><span style="color:#960050;background-color:#1e0010">&#39;</span>h000:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> ( byte_index <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; byte_index <span style="color:#f92672">&lt;=</span> (C_S_AXI_DATA_WIDTH<span style="color:#f92672">/</span><span style="color:#ae81ff">8</span>)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>; byte_index <span style="color:#f92672">=</span> byte_index<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">if</span> ( S_AXI_WSTRB[byte_index] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> ) begin
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// Respective byte enables are asserted as per write strobes 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#75715e">// Slave register 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                slv_reg0[(byte_index<span style="color:#f92672">*</span><span style="color:#ae81ff">8</span>) <span style="color:#f92672">+:</span> <span style="color:#ae81ff">8</span>] <span style="color:#f92672">&lt;=</span> S_AXI_WDATA[(byte_index<span style="color:#f92672">*</span><span style="color:#ae81ff">8</span>) <span style="color:#f92672">+:</span> <span style="color:#ae81ff">8</span>];
</span></span><span style="display:flex;"><span>              end  
</span></span><span style="display:flex;"><span>          <span style="color:#ae81ff">9</span><span style="color:#960050;background-color:#1e0010">&#39;</span>h001:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> ( byte_index <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; byte_index <span style="color:#f92672">&lt;=</span> (C_S_AXI_DATA_WIDTH<span style="color:#f92672">/</span><span style="color:#ae81ff">8</span>)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>; byte_index <span style="color:#f92672">=</span> byte_index<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">if</span> ( S_AXI_WSTRB[byte_index] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> ) begin
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// Respective byte enables are asserted as per write strobes 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#75715e">// Slave register 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                slv_reg1[(byte_index<span style="color:#f92672">*</span><span style="color:#ae81ff">8</span>) <span style="color:#f92672">+:</span> <span style="color:#ae81ff">8</span>] <span style="color:#f92672">&lt;=</span> S_AXI_WDATA[(byte_index<span style="color:#f92672">*</span><span style="color:#ae81ff">8</span>) <span style="color:#f92672">+:</span> <span style="color:#ae81ff">8</span>];
</span></span><span style="display:flex;"><span>              end  
</span></span><span style="display:flex;"><span>          <span style="color:#ae81ff">9</span><span style="color:#960050;background-color:#1e0010">&#39;</span>h002:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> ( byte_index <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; byte_index <span style="color:#f92672">&lt;=</span> (C_S_AXI_DATA_WIDTH<span style="color:#f92672">/</span><span style="color:#ae81ff">8</span>)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>; byte_index <span style="color:#f92672">=</span> byte_index<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">if</span> ( S_AXI_WSTRB[byte_index] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> ) begin
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// Respective byte enables are asserted as per write strobes 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#75715e">// Slave register 2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                slv_reg2[(byte_index<span style="color:#f92672">*</span><span style="color:#ae81ff">8</span>) <span style="color:#f92672">+:</span> <span style="color:#ae81ff">8</span>] <span style="color:#f92672">&lt;=</span> S_AXI_WDATA[(byte_index<span style="color:#f92672">*</span><span style="color:#ae81ff">8</span>) <span style="color:#f92672">+:</span> <span style="color:#ae81ff">8</span>];
</span></span><span style="display:flex;"><span>              end  
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>In this context, the hardware registers with names starting with &ldquo;slv_reg&rdquo; are each 32 bits wide, and their addresses are spaced by 4 bytes. So, for example, if the software-level address is <span class="optional">
  \( 0x00000018 \)
</span>
, you need to divide this address by 4, which results in <span class="optional">
  \( 24/4 = 6 \)
</span>
. Therefore, this address corresponds to the hardware register &ldquo;<code>slv_reg6</code>&rdquo; in the hardware module. This helps establish the correspondence between software and hardware registers.</p>
<h3 id="offline-analysis-and-design">
  Offline Analysis and Design
  <a class="anchor" href="#offline-analysis-and-design">#</a>
</h3>
<p>In the <code>offline_analyze</code> branch of the Toolkit, we perform packet capture and analysis by forwarding packets from the Toolkit to a powerful desktop computer after the timestamps the incoming packets. This method ensures that even at gigabit speeds, no packets are dropped, and there are relatively minor hardware changes.</p>
<p>One aspect of the modification is that timestamps are not added to the data frames when they are transmitted from the toolkit. This can be seen in the <code>HDL/trimode_mac/simple_mac_no_shared.v</code> file where the &ldquo;tsu_axis_tx&rdquo; section is commented out.</p>
<p>Another aspect is the modification of the &ldquo;frame_type&rdquo; to change the direction of data frames. Previously, both PTP frames and test data frames were uploaded to the PS section via time-synchronized DMA, with IT traffic uploaded to PS_ETH. This split the traffic into two directions (&ldquo;axis_switch_1_2&rdquo;). Now, it has been split into three directions (&ldquo;axis_switch_1_3&rdquo;). For offline analysis, only PTP frames need to be transferred to the PS, while test data frames need to be separated and sent out from ETH2. This requires a finer-grained separation of traffic.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span> <span style="color:#75715e">// separate IT frames, ptp frames and critical frames
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>axis_switch_1_3 <span style="color:#a6e22e">axis_switch_1_3_inst</span> (
</span></span><span style="display:flex;"><span>    .aclk(rx_fifo_clock),                    <span style="color:#75715e">// input wire aclk
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    .aresetn(rx_fifo_resetn),              <span style="color:#75715e">// input wire aresetn
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    .s_axis_tvalid(rx_axis_fifo_tvalid_8),  <span style="color:#75715e">// input wire [0 : 0] s_axis_tvalid
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    .s_axis_tready(rx_axis_fifo_tready_8),  <span style="color:#75715e">// output wire [0 : 0] s_axis_tready
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    .s_axis_tdata(rx_axis_fifo_tdata_8),    <span style="color:#75715e">// input wire [7 : 0] s_axis_tdata
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    .s_axis_tlast(rx_axis_fifo_tlast_8),    <span style="color:#75715e">// input wire [0 : 0] s_axis_tlast
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    .s_axis_tdest(frame_type),    <span style="color:#75715e">// input wire [1 : 0] s_axis_tdest
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    .m_axis_tvalid({rx_axis_it_fifo_tvalid, rx_axis_ptp_fifo_tvalid, tx_axis_fifo_legacy_tvalid[<span style="color:#ae81ff">1</span>]}),  <span style="color:#75715e">// output wire [2 : 0] m_axis_tvalid
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    .m_axis_tready({rx_axis_it_fifo_tready, rx_axis_ptp_fifo_tready, tx_axis_fifo_legacy_tready[<span style="color:#ae81ff">1</span>]}),  <span style="color:#75715e">// input wire [2 : 0] m_axis_tready
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    .m_axis_tdata({rx_axis_it_fifo_tdata, rx_axis_ptp_fifo_tdata, tx_axis_fifo_legacy_tdata[<span style="color:#ae81ff">1</span>]}),    <span style="color:#75715e">// output wire [23 : 0] m_axis_tdata
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    .m_axis_tlast({rx_axis_it_fifo_tlast, rx_axis_ptp_fifo_tlast, tx_axis_fifo_legacy_tlast[<span style="color:#ae81ff">1</span>]}),    <span style="color:#75715e">// output wire [2 : 0] m_axis_tlast
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    .m_axis_tdest(),    <span style="color:#75715e">// output wire [5 : 0] m_axis_tdest
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    .s_decode_err()    <span style="color:#75715e">// output wire [0 : 0] s_decode_err
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>);
</span></span></code></pre></div><p>The <code>tx_axis_fifo_legacy_tdata[1]</code> indicates sending from ETH2.</p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">




  <div>
    <a class="flex align-center" href="https://github.com/Mobisense/ziggo_book///tree/main//content/docs/device/system-design/index.md" target="_blank" rel="noopener">
      <img src="/svg/edit.svg" class="book-icon" alt="" />
      <span>Edit this page</span>
    </a>
  </div>


</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        <footer id="mu-footer" role="contentinfo" style="	height: 160px;
clear: both;
color: #000000;
text-align: center;
padding-top: 100px;">
    <div class="container">
        <div class="col-sm-12">
            <div>
                <p> Room 211, District 11, East Main Building, Tsinghua University, Haidian District, Beijing, China, 100084 | </p>
                <p> &copy 2021 <span class="ziggo-font">ZIGGO</span>, TNS, School of Software, Tsinghua University . All rights reserved. </p>
            </div>
        </div>
    </div>
</footer>
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  <div style="margin-top:10px; margin-bottom:40px; display:flex; justify-content:center; gap: 25px;">
    <a href="https://github.com/MobiSense/ziggo_book" style="padding: 10px 10px;
	background-color: rgb(0, 0, 0); /* 设置按钮背景色为橙色 */
	color: white; /* 设置按钮文字颜色为白色 */
	text-decoration: none; /* 去除链接的下划线 */
	border: 3px solid rgb(0, 0, 0);
	border-radius: 5px; /* 设置按钮的边角为圆角 */
	font-size: 14px; /* 设置文字大小 */
	text-align: center; /* 按钮内文字居中显示 */
	display: inline-block; /* 使链接的布局表现为块级元素 */">GitHub</a>
    <a href="https://mobisense.github.io/ziggo_homepage/" style="padding: 10px 10px;
	background-color: rgb(0, 0, 0); /* 设置按钮背景色为橙色 */
	color: white; /* 设置按钮文字颜色为白色 */
	text-decoration: none; /* 去除链接的下划线 */
	border: 3px solid rgb(0, 0, 0);
	border-radius: 5px; /* 设置按钮的边角为圆角 */
	font-size: 14px; /* 设置文字大小 */
	text-align: center; /* 按钮内文字居中显示 */
	display: inline-block; /* 使链接的布局表现为块级元素 */">Home</a>
</div>

<nav id="TableOfContents">
  <ul>
    <li><a href="#table-of-content">Table of Content</a></li>
    <li><a href="#evaluation-method">Evaluation Method</a></li>
    <li><a href="#test-data-frame-data-structure">Test data frame data structure</a></li>
    <li><a href="#module-design">Module Design</a>
      <ul>
        <li><a href="#correspondence-between-software-and-hardware-registers">Correspondence between software and hardware registers</a></li>
        <li><a href="#offline-analysis-and-design">Offline Analysis and Design</a></li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












